<!doctype html>
<html lang="de">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
Â  <title>ARea Viewer â€“ Surface AR</title>

Â  Â  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

Â  <style>
Â  Â  :root{
Â  Â  Â  color-scheme:dark light;
Â  Â  Â  /* NEU: Variable fÃ¼r den vertikalen Offset, wird im JS gesetzt */
Â  Â  Â  --model-vertical-offset: 0;
Â  Â  }
Â  Â  *,*::before,*::after{box-sizing:border-box}
Â  Â  html,body{
Â  Â  Â  margin:0;height:100%;
Â  Â  Â  background:#000 !important;
Â  Â  Â  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
Â  Â  Â  overscroll-behavior:none;touch-action:manipulation;
Â  Â  }

Â  Â  /* Poster */
Â  Â  #poster{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#05070c;z-index:9999;color:#fff;text-align:center;padding:24px}
Â  Â  #poster-inner{max-width:420px;width:100%;padding:24px 20px;border-radius:24px;background:radial-gradient(circle at top,#243b74,#05070c);box-shadow:0 18px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,.08)}
Â  Â  #posterImage{width:100%;max-height:220px;object-fit:cover;border-radius:16px;display:none;margin-bottom:16px;background:#111}
Â  Â  #poster h1{font-size:22px;margin:0 0 8px}
Â  Â  #poster p{margin:0 0 16px;font-size:14px;opacity:0.9}
Â  Â  #startAr{appearance:none;border:none;border-radius:999px;padding:10px 22px;font-size:15px;font-weight:500;background:linear-gradient(135deg,#5ddcff,#3c67e3);color:#fff;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.5)}
Â  Â  #startAr[disabled]{opacity:.55;cursor:wait}

Â  Â  /* model-viewer Host */
Â  Â  model-viewer{
Â  Â  Â  position:fixed;inset:0;width:100vw;height:100svh;display:block;
Â  Â  Â  background:#000 !important;z-index:1;
Â  Â  Â  /* NEU: Anwenden der vertikalen Verschiebung fÃ¼r Anti-Schwebe-Fix */
Â  Â  Â  transform: translateY(var(--model-vertical-offset)); 
Â  Â  }

Â  Â  /* Fehler */
Â  Â  #err{position:fixed;left:12px;top:12px;z-index:10000;background:#b00020;color:#fff;padding:8px 10px;border-radius:8px;display:none;font:12px/1.35 monospace;max-width:min(92vw,680px);white-space:pre-wrap}

Â  Â  /* AR UI â€“ Kamera-Toolbar (nur WebXR) */
Â  Â  #ar-ui{
Â  Â  Â  position:fixed;inset:0;z-index:9000;display:none;pointer-events:none;font-family:inherit;
Â  Â  }
Â  Â  .bottom-bar{
Â  Â  Â  position:absolute;left:0;right:0;bottom:max(env(safe-area-inset-bottom),16px);
Â  Â  Â  display:flex;align-items:center;justify-content:center;gap:22px;pointer-events:auto;padding:0 18px;
Â  Â  }
Â  Â  /* Buttons */
Â  Â  #btn-gallery{width:54px;height:54px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.25);background:#0b0f16 center/cover no-repeat;box-shadow:0 6px 16px rgba(0,0,0,.6)}
Â  Â  #btn-gallery img{width:100%;height:100%;object-fit:cover;display:block}
Â  Â  #btn-gallery:empty::after{content:"";display:block;width:100%;height:100%;background:linear-gradient(135deg,#2a3a52,#253044)}
Â  Â Â 
Â  Â  #btn-shutter{appearance:none;border:none;cursor:pointer;width:78px;height:78px;border-radius:50%;background:radial-gradient(circle at 50% 50%,#fff 60%,#dfe6f2 100%);box-shadow:0 8px 22px rgba(0,0,0,.55)}
Â  Â  #btn-shutter.recording{background:radial-gradient(circle at 50% 50%,#ff3b30 60%,#d7261b 100%);animation:pulse 1.1s ease-in-out infinite}
Â  Â  #btn-shutter.snap{animation:snap-blink 180ms ease-out}
Â  Â Â 
Â  Â  /* Mute Button Style */
Â  Â  #btn-mute{
Â  Â  Â  appearance:none;border:none;cursor:pointer;width:44px;height:44px;border-radius:50%;
Â  Â  Â  background:rgba(30,30,30,0.6);color:#fff;font-size:18px;
Â  Â  Â  display:flex;align-items:center;justify-content:center;
Â  Â  Â  backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.2);
Â  Â  Â  box-shadow:0 4px 12px rgba(0,0,0,.4);
Â  Â  }

Â  Â  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
Â  Â  @keyframes snap-blink{0%{transform:scale(1)}50%{transform:scale(.9)}100%{transform:scale(1)}}
Â  Â  #rec-info{position:absolute;bottom:calc(max(env(safe-area-inset-bottom),16px)+96px);left:50%;transform:translateX(-50%);
Â  Â  Â  background:#ff3b30;color:#fff;padding:4px 8px;border-radius:4px;font-size:14px;
Â  Â  Â  display:none;align-items:center;gap:4px;
Â  Â  }
Â  Â  #rec-info::before{content:"â—";font-size:10px;animation:pulse 1s infinite}
Â  </style>

</head>
<body>

Â  Â  <model-viewer id="modelViewer" 
Â  Â  loading="eager" 
Â  Â  poster="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" 
Â  Â  disable-tap>
Â  </model-viewer>

Â  Â  <div id="poster">
Â  Â  <div id="poster-inner">
Â  Â  Â  <img id="posterImage" src="" alt="Vorschaubild">
Â  Â  Â  <h1 id="posterTitle">3D / AR Erlebnis</h1>
Â  Â  Â  <p id="posterText">Tippe auf Start AR, um das Modell in deiner Umgebung zu sehen.</p>
Â  Â  Â  <button id="startAr">START AR</button>
Â  Â  </div>
Â  </div>

Â  Â  <div id="ar-ui">
Â  Â  <div class="bottom-bar">
Â  Â  Â  <button id="btn-mute" style="display:none">ğŸ”Š</button> Â  Â  Â  <div id="btn-gallery"></div>
Â  Â  Â  <button id="btn-shutter"></button>
Â  Â  Â  <div id="rec-info">00:00</div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="err"></div>

Â  Â  <script type="module">
import { fetchWithTimeout } from './js/publish-utils.js'; // Import der Hilfsfunktion

// --- KONSTANTEN und GLOBALE ZUSTÃ„NDE ---
const MODEL_VIEWER_TAG = 'model-viewer';
const MV_ID = 'modelViewer';
const ERR_ID = 'err';
const POSTER_ID = 'poster';
const AR_UI_ID = 'ar-ui';

let arAudio = null;
let cfg = null;
let isAudioMuted = false;
let isRecording = false; // Wird fÃ¼r die Video-/Screenshot-Logik benÃ¶tigt

// --- DOM-ELEMENTE ---
const modelViewer = document.getElementById(MV_ID);
const poster = document.getElementById(POSTER_ID);
const arUI = document.getElementById(AR_UI_ID);
const btnMute = document.getElementById('btn-mute');
const btnShutter = document.getElementById('btn-shutter');
const recInfo = document.getElementById('rec-info');
const errEl = document.getElementById(ERR_ID);
const startArButton = document.getElementById('startAr');

// --- HILFSFUNKTIONEN ---

function displayError(message) {
    console.error('VIEWER ERROR:', message);
    if (errEl) {
        errEl.textContent = 'FEHLER: ' + message;
        errEl.style.display = 'block';
    }
}

function updateMuteButtonUI() {
    btnMute.textContent = isAudioMuted ? 'ğŸ”‡' : 'ğŸ”Š';
}

/**
 * Initialisiert das Audio-Handling basierend auf der Szene-Konfiguration.
 */
function initAudio(audioCfg) {
    if (!audioCfg || !audioCfg.url) {
        if (btnMute) btnMute.style.display = 'none';
        return;
    }

    // Audio-Datei relativ zum Worker-Base Pfad laden
    const urlParams = new URLSearchParams(window.location.search);
    const sceneId = urlParams.get('scene');
    const workerBase = urlParams.get('base');
    const audioUrl = `${workerBase}/get/${sceneId}/${audioCfg.url}`;
    
    arAudio = new Audio(audioUrl);
    arAudio.loop = !!audioCfg.loop;
    arAudio.volume = audioCfg.volume !== undefined ? audioCfg.volume : 0.8;

    if (btnMute) {
        // Audio-Button anzeigen, da Audio konfiguriert ist
        btnMute.style.display = 'flex';
        updateMuteButtonUI();

        btnMute.onclick = () => {
            isAudioMuted = !isAudioMuted;
            arAudio.muted = isAudioMuted;
            updateMuteButtonUI();
        };
    }
}

/**
 * Steuert das Audio beim Start/Stopp von WebXR.
 */
function toggleAudio(play) {
    if (!arAudio) return;
    if (play) {
        if (!isAudioMuted) {
             // Delay-Support hinzufÃ¼gen
            const delay = cfg.audio?.delaySeconds || 0;
            if (delay > 0) {
                setTimeout(() => arAudio.play().catch(e => console.warn('Audio play failed:', e)), delay * 1000);
            } else {
                arAudio.play().catch(e => console.warn('Audio play failed:', e));
            }
        }
    } else {
        arAudio.pause();
        arAudio.currentTime = 0;
    }
}

/**
 * Wendet den Y-Offset zur Korrektur des Schwebens an.
 */
function applyYOffset(yOffset) {
    if (!modelViewer || !yOffset) return;

    // Der Offset wird als CSS Variable in Metern angewendet.
    // Wir nutzen die CSS-Variable, die wir im <style>-Block definiert haben.
    // model-viewer ist ein Web-Component, transform funktioniert gut.
    const offsetCSS = `${yOffset}m`;
    modelViewer.style.setProperty('--model-vertical-offset', offsetCSS);
    
    // Da model-viewer auch eine eigene Platzierungslogik hat (insbesondere im AR-Modus), 
    // kÃ¶nnen wir auch versuchen, die camera-orbit fÃ¼r den Nicht-AR-Modus anzupassen:
    // modelViewer.setAttribute('camera-orbit', `0deg 75deg ${modelViewer.getOrbit().radius}m`); 
    // ^ Dies ist komplex, der CSS-Transform ist der direkteste Weg.

    console.log(`Angewandter Y-Offset (Anti-Schwebe-Fix): ${offsetCSS}`);
}

// --- INITIALISIERUNG und EVENTS ---

/**
 * Hauptladefunktion.
 */
async function loadScene() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const sceneId = urlParams.get('scene');
        const workerBase = urlParams.get('base');

        if (!sceneId || !workerBase) {
            throw new Error('Fehlende URL-Parameter (scene/base).');
        }

        const sceneConfigUrl = `${workerBase}/get/${sceneId}/scene.json`;
        
        // 1. Konfiguration laden
        const response = await fetchWithTimeout(sceneConfigUrl, { timeoutMs: 15000 });
        if (!response.ok) throw new Error(`Laden von scene.json fehlgeschlagen: ${response.status}`);
        
        cfg = await response.json();

        // 2. Model-Viewer konfigurieren
        if (!cfg.model || !cfg.model.url) {
            throw new Error('Kein 3D-Modell in der Konfiguration gefunden.');
        }

        // NEU: Audio-URL im Konfig-Objekt muss den tatsÃ¤chlichen Dateinamen enthalten
        const modelUrl = `${workerBase}/get/${sceneId}/scene.glb`; // Das gemergete GLB
        modelViewer.setAttribute('src', modelUrl);
        modelViewer.setAttribute('alt', cfg.meta?.title || '3D-Modell');
        modelViewer.setAttribute('shadow-intensity', '1');
        modelViewer.setAttribute('camera-controls', '');
        modelViewer.setAttribute('auto-rotate', ''); 
        modelViewer.setAttribute('ar', '');
        modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
        modelViewer.setAttribute('interaction-prompt', 'none'); 
        modelViewer.setAttribute('auto-rotate-delay', '1000');
        modelViewer.setAttribute('disable-tap', ''); // Wir Ã¼bernehmen das Klick-Handling

        // 3. Audio initialisieren
        initAudio(cfg.audio);

        // 4. Anti-Schwebe-Fix anwenden
        if (cfg.model.yOffset !== undefined) {
             // Der Wert ist in Metern, kommt aus dem SceneManager
            applyYOffset(cfg.model.yOffset);
        }

        // 5. Poster-Text aktualisieren
        const posterTitle = document.getElementById('posterTitle');
        const posterText = document.getElementById('posterText');
        if (posterTitle) posterTitle.textContent = cfg.meta?.title || 'Augmented Reality Erlebnis';
        // Hier mÃ¼sste spÃ¤ter der anpassbare Text aus der Konfiguration geladen werden (Phase B)
        if (posterText) posterText.textContent = 'Tippe auf START AR, um das Modell in deiner Umgebung zu sehen.'; 
        
        // 6. Events hinzufÃ¼gen
        
        // Poster ausblenden, AR-UI einblenden, Audio starten, sobald AR/XR startet
        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                poster.style.display = 'none';
                arUI.style.display = 'block';
                toggleAudio(true);
            } else if (event.detail.status === 'session-ended') {
                arUI.style.display = 'none';
                toggleAudio(false);
                poster.style.display = 'flex';
            }
        });

        // Klick-Handling (URL-Weiterleitung)
        modelViewer.addEventListener('click', (event) => {
            if (!cfg.clickableNodes || cfg.clickableNodes.length === 0) return;
            
            // Wenn der Klick auf das Model-Viewer Element selbst (und nicht auf ein spezifisches Sub-Mesh)
            // und es ist im 3D- oder AR-Modus
            if (event.detail.target === modelViewer || event.detail.target.tagName === 'CANVAS') {
                const clickable = cfg.clickableNodes[0]; // Erstmal nur den ersten Link nehmen
                
                if (clickable && clickable.url) {
                    // Wenn in AR-Session, beenden und dann Ã¶ffnen
                    if (event.detail.sessionActive) {
                         modelViewer.stopAR();
                         // Warten auf session-ended, um Pop-up-Blocker zu vermeiden
                         setTimeout(() => window.open(clickable.url, '_blank'), 500); 
                    } else {
                        // Im 3D-Modus sofort Ã¶ffnen
                        window.open(clickable.url, '_blank');
                    }
                }
            }
        });
        
    } catch (error) {
        displayError(error.message);
    }
}

// Initialer Start des Ladevorgangs
document.addEventListener('DOMContentLoaded', () => {
    if (!modelViewer) {
        displayError('model-viewer Element fehlt.');
        return;
    }
    
    // Setzt das initial benÃ¶tigte CSS fÃ¼r den Y-Offset (kann spÃ¤ter Ã¼berschrieben werden)
    modelViewer.style.setProperty('--model-vertical-offset', '0'); 
    
    // Stellen Sie sicher, dass die Poster-ID's vorhanden sind, falls sie nicht im HTML gesetzt wurden.
    if(!document.getElementById('posterTitle') && document.querySelector('#poster-inner h1')) {
        document.querySelector('#poster-inner h1').id = 'posterTitle';
    }
    if(!document.getElementById('posterText') && document.querySelector('#poster-inner p')) {
        document.querySelector('#poster-inner p').id = 'posterText';
    }


    startArButton.onclick = () => {
        modelViewer.activateAR();
        startArButton.disabled = true; // Button sperren, bis AR startet
    }
    
    // Startet das Laden
    loadScene();
    
    // --- ACHTUNG: Hier fehlt die Shutter/Video-Logik, diese muss noch eingefÃ¼gt werden ---
});
Â  </script>

</body>
</html>
