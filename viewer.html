<!doctype html>
<html lang="de">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
Â  <title>ARea Viewer â€“ Surface AR</title>

Â  Â  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

Â  <style>
Â  Â  :root{color-scheme:dark light}
Â  Â  *,*::before,*::after{box-sizing:border-box}
Â  Â  html,body{
Â  Â  Â  margin:0;
Â  Â  Â  height:100%;
Â  Â  Â  background:#000;
Â  Â  Â  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
Â  Â  }

Â  Â  /* NEUES UI FÃœR AR-MODUS */
Â  Â  #ar-ui {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 15px; /* Abstand oben */
Â  Â  Â  Â  right: 15px; /* Abstand rechts */
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  display: none; /* Am Anfang versteckt */
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  flex-direction: row; /* Buttons nebeneinander */
Â  Â  Â  Â  /* FÃ¼gt Padding hinzu, um den Viewport-Fit zu respektieren, falls nÃ¶tig */
Â  Â  Â  Â  padding-right: env(safe-area-inset-right);
Â  Â  Â  Â  padding-top: env(safe-area-inset-top);
Â  Â  }

Â  Â  .ar-ui-button {
Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.4);
Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  font-size: 20px;
Â  Â  Â  Â  width: 44px;
Â  Â  Â  Â  height: 44px;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
Â  Â  Â  Â  transition: background 0.2s;
Â  Â  }

Â  Â  .ar-ui-button:hover {
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  }

Â  Â  /* Wichtig: Blendet die UI aus, wenn das Poster angezeigt wird */
Â  Â  #poster[style*="display: flex;"] + model-viewer + #ar-ui {
Â  Â  Â  Â  display: none !important;
Â  Â  }

Â  Â  /* Vollbild-Poster */
Â  Â  #poster{
Â  Â  Â  position:fixed;
Â  Â  Â  inset:0;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  background:#05070c;
Â  Â  Â  z-index:5;
Â  Â  Â  color:#fff;
Â  Â  Â  text-align:center;
Â  Â  Â  padding:24px;
Â  Â  }
Â  Â  #poster-inner{
Â  Â  Â  max-width:420px;
Â  Â  Â  width:100%;
Â  Â  Â  padding:24px 20px;
Â  Â  Â  border-radius:24px;
Â  Â  Â  background:radial-gradient(circle at top,#243b74,#05070c);
Â  Â  Â  box-shadow:0 18px 40px rgba(0,0,0,0.6);
Â  Â  Â  border:1px solid rgba(255,255,255,0.15);
Â  Â  }
Â  Â  #posterImage{
Â  Â  Â  width:100%;
Â  Â  Â  max-height:220px;
Â  Â  Â  object-fit:cover;
Â  Â  Â  border-radius:16px;
Â  Â  Â  display:none; /* nur zeigen, wenn wir eine URL haben */
Â  Â  Â  margin-bottom:16px;
Â  Â  Â  background:#111;
Â  Â  }
Â  Â  #poster h1{
Â  Â  Â  font-size:22px;
Â  Â  Â  margin:0 0 8px;
Â  Â  }
Â  Â  #poster p{
Â  Â  Â  margin:0 0 16px;
Â  Â  Â  font-size:14px;
Â  Â  Â  opacity:0.9;
Â  Â  }
Â  Â  #startAr{
Â  Â  Â  appearance:none;
Â  Â  Â  border:none;
Â  Â  Â  border-radius:999px;
Â  Â  Â  padding:10px 20px;
Â  Â  Â  font-size:15px;
Â  Â  Â  font-weight:500;
Â  Â  Â  background:linear-gradient(135deg,#5ddcff,#3c67e3);
Â  Â  Â  color:#fff;
Â  Â  Â  cursor:pointer;
Â  Â  Â  box-shadow:0 10px 25px rgba(0,0,0,0.5);
Â  Â  }
Â  Â  #startAr[disabled]{
Â  Â  Â  opacity:0.6;
Â  Â  Â  cursor:wait;
Â  Â  }

Â  Â  /* model-viewer als AR-Host (Preview wird vom Poster verdeckt) */
Â  Â  model-viewer{
Â  Â  Â  position:fixed;
Â  Â  Â  inset:0;
Â  Â  Â  width:100vw;
Â  Â  Â  height:100svh;
Â  Â  Â  display:block;
Â  Â  Â  background:#000;
Â  Â  }

Â  Â  #err{
Â  Â  Â  position:fixed;
Â  Â  Â  left:12px;
Â  Â  Â  top:12px;
Â  Â  Â  z-index:9;
Â  Â  Â  background:#b00020;
Â  Â  Â  color:#fff;
Â  Â  Â  padding:8px 10px;
Â  Â  Â  border-radius:8px;
Â  Â  Â  display:none;
Â  Â  Â  font:12px/1.35 monospace;
Â  Â  Â  max-width:min(92vw,680px);
Â  Â  Â  white-space:pre-wrap;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="err"></div>

Â  Â  <div id="poster">
Â  Â  <div id="poster-inner">
Â  Â  Â  <img id="posterImage" alt="">
Â  Â  Â  <h1 id="posterTitle">ARea AR-Erlebnis</h1>
Â  Â  Â  <p id="posterDesc">
Â  Â  Â  Â  Tippe auf â€AR startenâ€œ, richte dein GerÃ¤t auf eine ebene FlÃ¤che und platziere dann das 3D-Modell.
Â  Â  Â  </p>
Â  Â  Â  <button id="startAr">AR starten</button>
Â  Â  </div>
Â  </div>

Â  Â  <model-viewer id="mv"
Â  Â  src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
Â  Â  ar
Â  Â  ar-modes="webxr scene-viewer quick-look"
Â  Â  camera-controls
Â  Â  environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
Â  Â  exposure="1"
Â  Â  shadow-intensity="1"
Â  Â  interaction-prompt="none"
Â  Â  camera-orbit="0deg 70deg auto"
Â  Â  camera-target="auto"
Â  Â  field-of-view="30deg"
Â  Â  poster="">
Â  </model-viewer>

Â  <div id="ar-ui">
Â  Â  <button id="closeArBtn" class="ar-ui-button" title="AR beenden">
Â  Â  Â  Â  âŒ
Â  Â  </button>
Â  Â  <button id="captureButton" class="ar-ui-button" title="Foto aufnehmen">
Â  Â  Â  Â  ğŸ“¸
Â  Â  </button>
</div>

Â  <script type="module">
Â  (() => {
Â  Â  const qs = new URLSearchParams(location.search);
Â  Â  const devParam = qs.get('dev');
Â  Â  const DEV = qs.has('dev') && (devParam === null || devParam === '' || devParam === '1' || devParam === 'true');

Â  Â  function bust(u){
Â  Â  Â  if (!DEV || !u) return u;
Â  Â  Â  const sep = u.includes('?') ? '&' : '?';
Â  Â  Â  return u + sep + 'v=' + Date.now();
Â  Â  }

Â  Â  // --------- base-Parameter robust bereinigen ---------
Â  Â  const defaultBase = 'https://area-publish.area-webar.workers.dev';
Â  Â  const rawBase = (qs.get('base') || defaultBase);

Â  Â  let workerBase = rawBase;
Â  Â  workerBase = workerBase.split('"')[0];
Â  Â  workerBase = workerBase.split(',')[0];
Â  Â  workerBase = workerBase.trim();
Â  Â  workerBase = workerBase.replace(/\/scenes\/[^\/?#]+\/?$/,'');
Â  Â  workerBase = workerBase.replace(/\/+$/,'');

Â  Â  if (!/^https?:\/\//i.test(workerBase)) {
Â  Â  Â  console.warn('[area-viewer] UngÃ¼ltiger base-Parameter, verwende Default. Rohwert:', rawBase);
Â  Â  Â  workerBase = defaultBase;
Â  Â  }

Â  Â  console.log('[area-viewer] workerBase:', workerBase);

Â  Â  // --------- URL-Parsing / Szenenpfade ---------
Â  Â  const sceneId = (qs.get('scene') || qs.get('src') || '').trim();
Â  Â  const overrideGlbÂ  = (qs.get('glb')Â  || '').trim();
Â  Â  const overrideUsdz = (qs.get('usdz') || '').trim();

Â  Â  const isHttp = (u)=> /^https?:\/\//i.test(u);
Â  Â  const isDataOrBlob = (u)=> u.startsWith('data:') || u.startsWith('blob:');
Â  Â  const endsWithAny = (u,exts)=> exts.some(ext=> u.toLowerCase().endsWith(ext));

Â  Â  let SCENE_GLBÂ  = '';
Â  Â  let SCENE_JSON = '';

Â  Â  if (overrideGlb) {
Â  Â  Â  SCENE_GLB = overrideGlb;
Â  Â  }

Â  Â  if (sceneId) {
Â  Â  Â  if (isHttp(sceneId)) {
Â  Â  Â  Â  // Selten: scene als direkte URL
Â  Â  Â  Â  if (endsWithAny(sceneId, ['.glb','.gltf'])) {
Â  Â  Â  Â  Â  if (!SCENE_GLB) SCENE_GLB = sceneId;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  SCENE_JSON = sceneId;
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  const id = sceneId.replace(/\/+$/,'');
Â  Â  Â  Â  if (!SCENE_GLB) {
Â  Â  Â  Â  Â  SCENE_GLBÂ  = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.glb`;
Â  Â  Â  Â  }
Â  Â  Â  Â  SCENE_JSON = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.json`;
Â  Â  Â  }
Â  Â  }

Â  Â  console.log('[area-viewer] SCENE_GLB:', SCENE_GLB);
Â  Â  console.log('[area-viewer] SCENE_JSON:', SCENE_JSON);

Â  Â  // --------- DOM-Refs ---------
Â  Â  const errBoxÂ  Â  Â  = document.getElementById('err');
Â  Â  const mvÂ  Â  Â  Â  Â  = document.getElementById('mv');
Â  Â  const posterÂ  Â  Â  = document.getElementById('poster');
Â  Â  const startBtnÂ  Â  = document.getElementById('startAr');
Â  Â  const posterTitle = document.getElementById('posterTitle');
Â  Â  const posterDescÂ  = document.getElementById('posterDesc');
Â  Â  const posterImage = document.getElementById('posterImage');
    const arUi        = document.getElementById('ar-ui'); // NEU: AR UI Ref
    const closeArBtn  = document.getElementById('closeArBtn'); // NEU: Close Btn Ref
    const captureButton = document.getElementById('captureButton'); // NEU: Capture Btn Ref

Â  Â  function showError(msg){
Â  Â  Â  errBox.textContent = msg;
Â  Â  Â  errBox.style.display = 'block';
Â  Â  Â  console.error('[area-viewer]', msg);
Â  Â  }

Â  Â  // --------- Konfig mit Defaults ---------
Â  Â  const cfg = {
Â  Â  Â  glbUrl: SCENE_GLB || "https://modelviewer.dev/shared-assets/models/Astronaut.glb",
Â  Â  Â  usdzUrl: null,
Â  Â  Â  animation: {
Â  Â  Â  Â  clipName: "*",
Â  Â  Â  Â  loop: true,Â  Â  Â  Â  // true = wiederholen, false = einmal
Â  Â  Â  Â  iterations: 9999Â  Â // Anzahl Wiederholungen, bei loop=true
Â  Â  Â  },
Â  Â  Â  meta:{
Â  Â  Â  Â  title: null,
Â  Â  Â  Â  description: null
Â  Â  Â  },
Â  Â  Â  welcome:{
Â  Â  Â  Â  eyebrow: "",
Â  Â  Â  Â  title: "",
Â  Â  Â  Â  desc: "",
Â  Â  Â  Â  posterFile: null
Â  Â  Â  }
Â  Â  };

Â  Â  // --------- Szene + JSON laden (MIT URL-FIX) ---------
Â  Â  (async () => {
Â  Â  Â  try {
Â  Â  Â  Â  if (SCENE_JSON && !isDataOrBlob(SCENE_JSON)) {
Â  Â  Â  Â  Â  const r = await fetch(bust(SCENE_JSON), { cache:'no-cache' });
Â  Â  Â  Â  Â  if (!r.ok) throw new Error('scene.json: ' + r.status + ' ' + r.statusText);
Â  Â  Â  Â  Â  const j = await r.json();
Â  Â  Â  Â  Â  console.log('[area-viewer] scene.json:', j);

Â  Â  Â  Â  Â  // Animation
Â  Â  Â  Â  Â  if (j.animation) {
Â  Â  Â  Â  Â  Â  if (j.animation.clipName)Â  Â cfg.animation.clipNameÂ  Â = String(j.animation.clipName);
Â  Â  Â  Â  Â  Â  if (typeof j.animation.loop === 'boolean') cfg.animation.loop = j.animation.loop;
Â  Â  Â  Â  Â  Â  if (Number.isFinite(j.animation.iterations)) cfg.animation.iterations = j.animation.iterations|0;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Meta
Â  Â  Â  Â  Â  if (j.meta) {
Â  Â  Â  Â  Â  Â  if (typeof j.meta.title === 'string')Â  Â  Â  Â cfg.meta.titleÂ  Â  Â  Â = j.meta.title;
Â  Â  Â  Â  Â  Â  if (typeof j.meta.description === 'string') cfg.meta.description = j.meta.description;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Welcome / Poster (Light-Editor: ui.welcome.*)
Â  Â  Â  Â  Â  if (j.ui && j.ui.welcome) {
Â  Â  Â  Â  Â  Â  const wl = j.ui.welcome;
Â  Â  Â  Â  Â  Â  if (typeof wl.title === 'string' && wl.title)Â  Â cfg.welcome.titleÂ  Â = wl.title;
Â  Â  Â  Â  Â  Â  if (typeof wl.desc === 'string' && wl.desc)Â  Â  Â cfg.welcome.descÂ  Â  = wl.desc;
Â  Â  Â  Â  Â  Â  if (typeof wl.eyebrow === 'string' && wl.eyebrow) cfg.welcome.eyebrow = wl.eyebrow;
Â  Â  Â  Â  Â  Â  if (typeof wl.poster === 'string' && wl.poster) cfg.welcome.posterFile = wl.poster;
Â  Â  Â  Â  Â  }

            // === START: KORRIGIERTE URL-BESTIMMUNGS-LOGIK ===
Â  Â  Â  Â  Â  Â  // Model-URL (relativ aus JSON) VOR SCENE_GLB als Fallback
Â  Â  Â  Â  Â  Â  if (j.model && j.model.url && !overrideGlb) {
Â  Â  Â  Â  Â  Â  Â  Â  if (sceneId && !isHttp(j.model.url)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Wenn relative URL im JSON und wir eine sceneId haben
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cfg.glbUrl = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/${j.model.url}`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Absolute URL oder keine sceneId
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cfg.glbUrl = j.model.url;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (!SCENE_GLB) {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback auf die geratene scene.glb, falls nichts anderes gesetzt
Â  Â  Â  Â  Â  Â  Â  Â  if (sceneId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cfg.glbUrl = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/scene.glb`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // HIER: SCENE_GLB hat Vorrang, falls gesetzt (via URL-Param 'glb')
Â  Â  Â  Â  Â  Â  if (SCENE_GLB) {
Â  Â  Â  Â  Â  Â  Â  Â  cfg.glbUrl = SCENE_GLB;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // USDZ-URL setzen (fÃ¼r iOS Quick Look)
Â  Â  Â  Â  Â  Â  if (overrideUsdz) {
Â  Â  Â  Â  Â  Â  Â  Â  cfg.usdzUrl = overrideUsdz;
Â  Â  Â  Â  Â  Â  } else if (j.model && j.model.usdzUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  // USDZ aus scene.json (wichtig fÃ¼r iOS!)
Â  Â  Â  Â  Â  Â  Â  Â  cfg.usdzUrl = j.model.usdzUrl;
Â  Â  Â  Â  Â  Â  } else if (sceneId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback: Geratene scene.usdz
Â  Â  Â  Â  Â  Â  Â  Â  cfg.usdzUrl = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/scene.usdz`;
Â  Â  Â  Â  Â  Â  }
            // === ENDE: KORRIGIERTE URL-BESTIMMUNGS-LOGIK ===
Â  Â  Â  Â  }

Â  Â  Â  Â  // Texte auf Poster anwenden
Â  Â  Â  Â  const finalTitle = cfg.meta.title || cfg.welcome.title || "ARea AR-Erlebnis";
Â  Â  Â  Â  const finalDescÂ  = cfg.meta.description || cfg.welcome.desc ||
Â  Â  Â  Â  Â  "Tippe auf â€AR startenâ€œ, richte dein GerÃ¤t auf eine ebene FlÃ¤che und platziere dann das 3D-Modell.";

Â  Â  Â  Â  posterTitle.textContent = finalTitle;
Â  Â  Â  Â  posterDesc.textContentÂ  = finalDesc;

Â  Â  Â  Â  // Poster-Bild: bevorzugt ui.welcome.poster (Dateiname aus Editor)
Â  Â  Â  Â  let posterUrl = null;
Â  Â  Â  Â  if (cfg.welcome.posterFile && sceneId) {
Â  Â  Â  Â  Â  posterUrl = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/${encodeURIComponent(cfg.welcome.posterFile)}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (posterUrl) {
Â  Â  Â  Â  Â  posterImage.src = posterUrl;
Â  Â  Â  Â  Â  posterImage.style.display = 'block';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  posterImage.style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  // finale GLB-URL setzen
Â  Â  Â  Â  const finalGlb = cfg.glbUrl || "https://modelviewer.dev/shared-assets/models/Astronaut.glb";
Â  Â  Â  Â  mv.src = bust(finalGlb);

Â  Â  Â  Â  // finale USDZ-URL setzen
Â  Â  Â  Â  if (cfg.usdzUrl) {
Â  Â  Â  Â  Â  mv.setAttribute('ios-src', bust(cfg.usdzUrl));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  mv.removeAttribute('ios-src');
Â  Â  Â  Â  }

Â  Â  Â  } catch(e){
Â  Â  Â  Â  showError('Szene konnte nicht geladen werden: ' + e.message);
Â  Â  Â  Â  console.error(e);
Â  Â  Â  }
Â  Â  })();

Â  Â  // --------- Animation + Loop / Wiederholungen ---------
Â  Â  mv.addEventListener('load', () => {
Â  Â  Â  const names = mv.availableAnimations || [];
Â  Â  Â  console.log('[area-viewer] availableAnimations:', names);

Â  Â  Â  // Clip auswÃ¤hlen: cfg.animation.clipName oder fallback erster Clip
Â  Â  Â  let sel = cfg.animation.clipName;
Â  Â  Â  let chosen = null;

Â  Â  Â  if (sel === 'none') {
Â  Â  Â  Â  chosen = null;
Â  Â  Â  } else if (sel === '*' || sel == null) {
Â  Â  Â  Â  chosen = names[0] || null;
Â  Â  Â  } else if (typeof sel === 'string') {
Â  Â  Â  Â  if (/^\d+$/.test(sel)) {
Â  Â  Â  Â  Â  const idx = Math.max(0, Math.min(names.length-1, parseInt(sel,10)));
Â  Â  Â  Â  Â  chosen = names[idx] || null;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  chosen = names.includes(sel) ? sel : (names[0] || null);
Â  Â  Â  Â  }
Â  Â  Â  } else if (Number.isFinite(sel)) {
Â  Â  Â  Â  const idx = Math.max(0, Math.min(names.length-1, sel|0));
Â  Â  Â  Â  chosen = names[idx] || null;
Â  Â  Â  }

Â  Â  Â  console.log('[area-viewer] chosen animation:', chosen,
Â  Â  Â  Â  Â  Â  Â  Â  Â  'loop:', cfg.animation.loop,
Â  Â  Â  Â  Â  Â  Â  Â  Â  'iterations:', cfg.animation.iterations);

Â  Â  Â  if (!chosen) {
Â  Â  Â  Â  mv.animationName = null;
Â  Â  Â  Â  mv.autoplay = false;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  mv.animationName = chosen;
Â  Â  Â  mv.autoplay = true;

Â  Â  Â  try { mv.play(); } catch(e){ console.warn('[area-viewer] play() failed:', e); }

Â  Â  Â  // Loop-Logik:
Â  Â  Â  // - loop = trueÂ  + iterationsÂ  = NÂ  â†’ N Wiederholungen, dann Pause
Â  Â  Â  // - loop = trueÂ  + iterations >= 9999 â†’ effektiv: Endlosschleife
Â  Â  Â  // - loop = false â†’ einmal abspielen
Â  Â  Â  const loopFlag = !!cfg.animation.loop;
Â  Â  Â  const itRawÂ  Â  = cfg.animation.iterations;
Â  Â  Â  let repeatTotal = null;

Â  Â  Â  if (loopFlag) {
Â  Â  Â  Â  if (Number.isFinite(itRaw) && itRaw > 0 && itRaw < 9999) {
Â  Â  Â  Â  Â  repeatTotal = itRaw;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Endlosschleife â†’ kein Counter
Â  Â  Â  Â  Â  repeatTotal = null;
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  repeatTotal = 1; // einmal abspielen
Â  Â  Â  }

Â  Â  Â  if (repeatTotal && repeatTotal > 0) {
Â  Â  Â  Â  let loopsÂ  Â  = 0;
Â  Â  Â  Â  let lastTime = 0;
Â  Â  Â  Â  let stoppedÂ  = false;

Â  Â  Â  Â  const onTimeUpdate = () => {
Â  Â  Â  Â  Â  if (stopped) return;
Â  Â  Â  Â  Â  const t = mv.currentTime || 0;
Â  Â  Â  Â  Â  // Wenn currentTime "zurÃ¼ckspringt" â†’ neuer Loop
Â  Â  Â  Â  Â  if (t < lastTime) {
Â  Â  Â  Â  Â  Â  loops++;
Â  Â  Â  Â  Â  Â  console.log('[area-viewer] loop detected, count =', loops);
Â  Â  Â  Â  Â  Â  if (loops >= repeatTotal) {
Â  Â  Â  Â  Â  Â  Â  try { mv.pause(); } catch {}
Â  Â  Â  Â  Â  Â  Â  stopped = true;
Â  Â  Â  Â  Â  Â  Â  mv.removeEventListener('timeupdate', onTimeUpdate);
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  lastTime = t;
Â  Â  Â  Â  };

Â  Â  Â  Â  mv.addEventListener('timeupdate', onTimeUpdate);
Â  Â  Â  }
Â  Â  });
    
Â  Â  // --------- NEUE UI LOGIK (CLOSE & CAPTURE) ---------
Â  Â  
Â  Â  // Funktion zum Ausblenden der UI und Beenden der AR-Sitzung
Â  Â  closeArBtn?.addEventListener('click', () => {
Â  Â  Â  Â  // Deaktiviert die AR-Sitzung, falls aktiv
Â  Â  Â  Â  if (mv.isArActive) {
Â  Â  Â  Â  Â  Â  mv.stopAr();
Â  Â  Â  Â  }
Â  Â  Â  Â  // Blendet die AR-UI aus und zeigt das Poster wieder an
Â  Â  Â  Â  arUi.style.display = 'none';
Â  Â  Â  Â  poster.style.display = 'flex';
Â  Â  });
Â  Â Â 
Â  Â  // Foto-Funktion
Â  Â  captureButton?.addEventListener('click', () => {
Â  Â  Â  Â  const canvas = document.querySelector('canvas');Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!canvas) {
Â  Â  Â  Â  Â  Â  showError("Canvas fÃ¼r die Aufnahme nicht gefunden.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  canvas.toBlob((blob) => {
Â  Â  Â  Â  Â  Â  if (!blob) return;

Â  Â  Â  Â  Â  Â  // Link-Element erstellen, um den Download zu triggern
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.download = 'area-ar-scene-' + Date.now().toString(36) + '.png';
Â  Â  Â  Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(link.href);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  }, 'image/png');
Â  Â  });

Â  Â  // Event, das feuert, wenn AR erfolgreich gestartet wird
Â  Â  mv.addEventListener('ar-status', (event) => {
Â  Â  Â  Â  if (event.detail.status === 'session-started') {
Â  Â  Â  Â  Â  Â  arUi.style.display = 'flex'; // UI einblenden
Â  Â  Â  Â  } else if (event.detail.status === 'not-presenting') {
Â  Â  Â  Â  Â  Â  Â arUi.style.display = 'none'; // UI ausblenden, wenn AR beendet wird
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --------- AR-Start Ã¼ber Poster-Button (MIT SUPPORT CHECK FIX) ---------
Â  Â  startBtn.addEventListener('click', async (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  ev.stopPropagation();

Â  Â  Â  Â  if (!mv.hasAttribute('ar')) {
Â  Â  Â  Â  Â  Â  showError('AR ist fÃ¼r diese Szene nicht aktiviert (fehlendes "ar"-Attribut).');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // NEU: PrÃ¼fung, ob AR-Session Ã¼berhaupt gestartet werden kann
Â  Â  Â  Â  if (typeof mv.canActivateAR === 'function' && !mv.canActivateAR()) {
Â  Â  Â  Â  Â  Â  showError('AR wird von diesem GerÃ¤t/Browser nicht unterstÃ¼tzt oder das Modell ist nicht verfÃ¼gbar (z.B. fehlende USDZ auf iOS).');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  startBtn.disabled = true;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  poster.style.display = 'none';

Â  Â  Â  Â  Â  Â  if (typeof mv.activateAR === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  await mv.activateAR();
Â  Â  Â  Â  Â  Â  } else if (typeof mv.enterAR === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback fÃ¼r Ã¤ltere model-viewer Versionen
Â  Â  Â  Â  Â  Â  Â  Â  await mv.enterAR();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('AR-Funktion nicht gefunden. model-viewer veraltet?');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  showError('AR konnte nicht gestartet werden: ' + e.message);
Â  Â  Â  Â  Â  Â  console.error('[area-viewer] AR start error', e);
Â  Â  Â  Â  Â  Â  poster.style.display = 'flex';
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  startBtn.disabled = false;
Â  Â  Â  Â  }
Â  Â  });
    // --------- ENDE AR-Start Button Logik ---------

})();
</script>

</body>
</html>
