<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ARea Viewer â€“ Surface AR</title>

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{color-scheme:dark light}
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0;
      height:100%;
      background:#000 !important;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      overscroll-behavior:none;
      touch-action:manipulation;
    }

    /* Vollbild-Poster Overlay */
    #poster{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#05070c;
      z-index:9999;
      color:#fff;
      text-align:center;
      padding:24px;
    }
    #poster-inner{
      max-width:420px;
      width:100%;
      padding:24px 20px;
      border-radius:24px;
      background:radial-gradient(circle at top,#243b74,#05070c);
      box-shadow:0 18px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.15);
    }
    #posterImage{
      width:100%;
      max-height:220px;
      object-fit:cover;
      border-radius:16px;
      display:none;
      margin-bottom:16px;
      background:#111;
    }
    #poster h1{
      font-size:22px;
      margin:0 0 8px;
    }
    #poster p{
      margin:0 0 16px;
      font-size:14px;
      opacity:0.9;
    }
    #startAr{
      appearance:none;
      border:none;
      border-radius:999px;
      padding:10px 22px;
      font-size:15px;
      font-weight:500;
      background:linear-gradient(135deg,#5ddcff,#3c67e3);
      color:#fff;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,0.5);
    }
    #startAr[disabled]{ opacity:.55; cursor:wait; }

    /* model-viewer Host */
    model-viewer{
      position:fixed;
      inset:0;
      width:100vw;
      height:100svh;
      display:block;
      background:#000 !important;
      z-index:1;
    }

    /* Fehler-Anzeige */
    #err{
      position:fixed;
      left:12px;
      top:12px;
      z-index:10000;
      background:#b00020;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      display:none;
      font:12px/1.35 monospace;
      max-width:min(92vw,680px);
      white-space:pre-wrap;
      box-shadow:0 4px 16px rgba(0,0,0,.5);
    }

    /* AR UI Overlay (Buttons wÃ¤hrend AR) */
    #ar-ui{
      position:fixed;
      inset:0;
      z-index:9000;
      display:none;
      pointer-events:none;
      font-family:inherit;
    }
    #ar-ui .toolbar{
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:auto;
    }
    .ar-btn{
      appearance:none;
      border:none;
      border-radius:10px;
      padding:8px 12px;
      font-size:13px;
      font-weight:500;
      background:#1d2736;
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 4px 12px rgba(0,0,0,.5);
      backdrop-filter:blur(6px);
    }
    .ar-btn.primary{ background:linear-gradient(135deg,#5ddcff,#3c67e3); }
    .ar-btn.danger{ background:#b00020; }
    .ar-btn:active{ transform:translateY(1px); }

    #captureStatus{
      position:absolute;
      bottom:14px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.65);
      color:#fff;
      font:12px/1.3 monospace;
      padding:6px 10px;
      border-radius:8px;
      display:none;
      pointer-events:none;
      box-shadow:0 4px 14px rgba(0,0,0,.6);
    }

    @media (max-width:480px){
      #poster-inner{ padding:20px 16px; }
      #poster h1{ font-size:20px; }
      #startAr{ font-size:14px; padding:9px 18px; }
      .ar-btn{ font-size:12px; padding:7px 10px; }
    }
  </style>
</head>
<body>
  <div id="err"></div>

  <!-- Poster -->
  <div id="poster">
    <div id="poster-inner">
      <img id="posterImage" alt="">
      <h1 id="posterTitle">ARea AR-Erlebnis</h1>
      <p id="posterDesc">Tippe auf â€žAR startenâ€œ, richte dein GerÃ¤t auf eine ebene FlÃ¤che und platziere dann das 3D-Modell.</p>
      <button id="startAr">AR starten</button>
    </div>
  </div>

  <!-- AR UI -->
  <div id="ar-ui">
    <div class="toolbar">
      <button id="btn-capture" class="ar-btn primary" title="Screenshot (PNG)">ðŸ“· Screenshot</button>
      <button id="btn-video" class="ar-btn" title="Videoaufnahme ein/aus">ðŸŽ¬ Video</button>
      <button id="btn-close-ar" class="ar-btn danger" title="AR beenden">âœ• Beenden</button>
    </div>
    <div id="captureStatus"></div>
  </div>

  <!-- model-viewer -->
  <model-viewer id="mv"
    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
    exposure="1"
    shadow-intensity="1"
    interaction-prompt="none"
    camera-orbit="0deg 70deg auto"
    camera-target="auto"
    field-of-view="30deg"
    poster="">
  </model-viewer>

  <script type="module">
  (() => {
    /********************
     * Utility & State  *
     ********************/
    const qs = new URLSearchParams(location.search);
    const devParam = qs.get('dev');
    const DEV = qs.has('dev') && (devParam === null || devParam === '' || devParam === '1' || devParam === 'true');

    const errBox = document.getElementById('err');
    const mv = document.getElementById('mv');
    const poster = document.getElementById('poster');
    const posterTitle = document.getElementById('posterTitle');
    const posterDesc  = document.getElementById('posterDesc');
    const posterImage = document.getElementById('posterImage');
    const startBtn    = document.getElementById('startAr');

    const arUi         = document.getElementById('ar-ui');
    const btnCapture   = document.getElementById('btn-capture');
    const btnVideo     = document.getElementById('btn-video');
    const btnCloseAr   = document.getElementById('btn-close-ar');
    const captureStatus= document.getElementById('captureStatus');

    let mediaRecorder = null;
    let recordedChunks = [];
    let recording = false;

    function showError(msg){
      errBox.textContent = msg;
      errBox.style.display = 'block';
      console.error('[viewer]', msg);
    }
    function hideError(){
      errBox.style.display='none';
    }
    function bust(u){
      if (!DEV || !u) return u;
      const sep = u.includes('?')?'&':'?';
      return u + sep + 'v=' + Date.now();
    }
    async function headOk(url){
      try {
        const r = await fetch(bust(url), { method:'HEAD', cache:'no-cache' });
        return r.ok;
      } catch { return false; }
    }

    /**********************
     * Base + Scene Param *
     **********************/
    const defaultBase = 'https://area-publish.area-webar.workers.dev';
    const rawBase = (qs.get('base') || defaultBase);

    let workerBase = rawBase.split('"')[0].split(',')[0].trim()
      .replace(/\/scenes\/[^\/?#]+\/?$/,'')
      .replace(/\/+$/,'');
    if (!/^https?:\/\//i.test(workerBase)){
      console.warn('[viewer] UngÃ¼ltiger base, fallback:', rawBase);
      workerBase = defaultBase;
    }

    const sceneId      = (qs.get('scene') || qs.get('src') || '').trim();
    const overrideGlb  = (qs.get('glb')  || '').trim();
    const overrideUsdz = (qs.get('usdz') || '').trim();

    const isHttp       = (u)=> /^https?:\/\//i.test(u);
    const isDataOrBlob = (u)=> u.startsWith('data:') || u.startsWith('blob:');

    let SCENE_GLB  = '';
    let SCENE_JSON = '';

    if (overrideGlb) SCENE_GLB = overrideGlb;

    if (sceneId){
      if (isHttp(sceneId)){
        if (sceneId.toLowerCase().match(/\.(glb|gltf)$/)) {
          if (!SCENE_GLB) SCENE_GLB = sceneId;
        } else {
          SCENE_JSON = sceneId;
        }
      } else {
        const id = sceneId.replace(/\/+$/,'');
        if (!SCENE_GLB) SCENE_GLB = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.glb`;
        SCENE_JSON = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.json`;
      }
    }

    /***********************
     * Config Objekt       *
     ***********************/
    const cfg = {
      glbUrl: SCENE_GLB || "https://modelviewer.dev/shared-assets/models/Astronaut.glb",
      usdzUrl: null,
      animation:{ clipName:"*", loop:true, iterations:9999 },
      meta:{ title:null, description:null },
      welcome:{ eyebrow:"", title:"", desc:"", posterFile:null }
    };

    /***********************
     * Szene laden         *
     ***********************/
    (async () => {
      try {
        if (SCENE_JSON && !isDataOrBlob(SCENE_JSON)){
          const r = await fetch(bust(SCENE_JSON), { cache:'no-cache' });
          if (!r.ok) throw new Error('scene.json: ' + r.status + ' ' + r.statusText);
          const j = await r.json();
          console.log('[viewer] scene.json:', j);

          // Meta
          if (j.meta){
            if (typeof j.meta.title === 'string')       cfg.meta.title       = j.meta.title;
            if (typeof j.meta.description === 'string') cfg.meta.description = j.meta.description;
          }
          // Welcome / Poster
          if (j.ui && j.ui.welcome){
            const wl = j.ui.welcome;
            if (typeof wl.title === 'string' && wl.title)   cfg.welcome.title   = wl.title;
            if (typeof wl.desc === 'string' && wl.desc)     cfg.welcome.desc    = wl.desc;
            if (typeof wl.poster === 'string' && wl.poster) cfg.welcome.posterFile = wl.poster;
          }
          // Model URL Vorrang
            if (j.model && j.model.url && !overrideGlb){
              cfg.glbUrl = isHttp(j.model.url) ? j.model.url
                          : (sceneId ? `${workerBase}/scenes/${encodeURIComponent(sceneId)}/${j.model.url}` : j.model.url);
              SCENE_GLB = cfg.glbUrl;
            }
            if (j.model && j.model.usdzUrl && !overrideUsdz){
              cfg.usdzUrl = isHttp(j.model.usdzUrl) ? j.model.usdzUrl
                          : (sceneId ? `${workerBase}/scenes/${encodeURIComponent(sceneId)}/${j.model.usdzUrl}` : j.model.usdzUrl);
            }
        }

        // Poster-Texte
        const finalTitle = cfg.meta.title || cfg.welcome.title || "ARea AR-Erlebnis";
        const finalDesc  = cfg.meta.description || cfg.welcome.desc ||
          "Tippe auf â€žAR startenâ€œ, richte dein GerÃ¤t auf eine ebene FlÃ¤che und platziere dann das 3D-Modell.";

        posterTitle.textContent = finalTitle;
        posterDesc.textContent  = finalDesc;

        // Poster-Bild
        if (cfg.welcome.posterFile && sceneId){
          const posterUrl = `${workerBase}/scenes/${encodeURIComponent(sceneId)}/${encodeURIComponent(cfg.welcome.posterFile)}`;
          posterImage.src = bust(posterUrl);
          posterImage.style.display = 'block';
        } else {
          posterImage.style.display = 'none';
        }

        // finale GLB
        const finalGlb = SCENE_GLB || cfg.glbUrl;
        if (finalGlb && !(await headOk(finalGlb))){
          showError('GLB nicht gefunden: ' + finalGlb);
        }
        mv.src = bust(finalGlb);

        // USDZ
        const finalUsdz = overrideUsdz || cfg.usdzUrl || null;
        if (finalUsdz) mv.setAttribute('ios-src', finalUsdz);
        else mv.removeAttribute('ios-src');

      } catch(e){
        showError('Szene konnte nicht geladen werden: ' + e.message);
        console.error(e);
      }
    })();

    /***********************
     * Animation Handling  *
     ***********************/
    mv.addEventListener('load', () => {
      const names = mv.availableAnimations || [];
      let sel = cfg.animation.clipName;
      let chosen = null;

      if (sel === 'none') chosen = null;
      else if (sel === '*' || sel == null) chosen = names[0] || null;
      else if (typeof sel === 'string'){
        if (/^\d+$/.test(sel)){
          const idx = Math.min(names.length-1, parseInt(sel,10));
          chosen = names[idx] || null;
        } else {
          chosen = names.includes(sel) ? sel : (names[0] || null);
        }
      } else if (Number.isFinite(sel)){
        const idx = Math.min(names.length-1, sel|0);
        chosen = names[idx] || null;
      }

      if (!chosen){
        mv.animationName = null;
        mv.autoplay = false;
        return;
      }
      mv.animationName = chosen;
      mv.autoplay = true;
      try { mv.play(); } catch(e){ console.warn('play() failed:', e); }
    });

    /***********************
     * AR Status Events    *
     ***********************/
    mv.addEventListener('ar-status', (e) => {
      // session-started / not-presenting
      if (e.detail.status === 'session-started'){
        arUi.style.display = 'block';
      } else if (e.detail.status === 'not-presenting'){
        arUi.style.display = 'none';
        poster.style.display = 'flex';
        stopVideoRecording(false);
      }
    });

    /***********************
     * AR Start Button     *
     ***********************/
    startBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      hideError();

      if (!mv.hasAttribute('ar')){
        showError('AR nicht aktiviert (Attribut "ar" fehlt).');
        return;
      }
      if (typeof mv.canActivateAR === 'function' && !mv.canActivateAR()){
        showError('AR von GerÃ¤t/Browser nicht unterstÃ¼tzt (oder iOS Quick Look ohne USDZ).');
        return;
      }

      startBtn.disabled = true;
      try {
        // Erst AR starten, dann Poster ausblenden (verhindert â€žweiÃŸes Modellâ€œ)
        if (typeof mv.activateAR === 'function'){
          await mv.activateAR();
        } else if (typeof mv.enterAR === 'function'){
          await mv.enterAR();
        } else {
          throw new Error('AR-Funktion nicht verfÃ¼gbar.');
        }
        poster.style.display = 'none';
      } catch(e){
        showError('AR konnte nicht gestartet werden: ' + e.message);
        poster.style.display = 'flex';
        console.error('[viewer] AR error', e);
      } finally {
        startBtn.disabled = false;
      }
    });

    /***********************
     * AR Close            *
     ***********************/
    btnCloseAr.addEventListener('click', () => {
      try {
        if (mv.isArActive && typeof mv.stopAr === 'function'){
          mv.stopAr();
        }
      } catch(_) {}
      arUi.style.display='none';
      poster.style.display='flex';
      stopVideoRecording(false);
    });

    /***********************
     * Screenshot Capture  *
     ***********************/
    btnCapture.addEventListener('click', () => {
      const canvas = mv.shadowRoot?.querySelector('canvas') || document.querySelector('canvas');
      if (!canvas){
        showError('Kein Canvas fÃ¼r Screenshot gefunden.');
        return;
      }
      canvas.toBlob(blob => {
        if (!blob) return;
        const a = document.createElement('a');
        a.download = 'area-ar-' + Date.now().toString(36) + '.png';
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        flashCaptureStatus('Screenshot gespeichert');
      }, 'image/png');
    });

    /***********************
     * Video Recording     *
     ***********************/
    function flashCaptureStatus(msg){
      captureStatus.textContent = msg;
      captureStatus.style.display='block';
      clearTimeout(captureStatus._t);
      captureStatus._t = setTimeout(()=> captureStatus.style.display='none', 1800);
    }

    function startVideoRecording(){
      if (recording) return;
      const canvas = mv.shadowRoot?.querySelector('canvas') || document.querySelector('canvas');
      if (!canvas){
        showError('Canvas fÃ¼r Video nicht gefunden.');
        return;
      }
      if (!canvas.captureStream){
        showError('Videoaufnahme nicht unterstÃ¼tzt.');
        return;
      }
      const stream = canvas.captureStream(30);
      const options = { mimeType: 'video/webm;codecs=vp9' };
      try {
        mediaRecorder = new MediaRecorder(stream, options);
      } catch(e){
        try { mediaRecorder = new MediaRecorder(stream); }
        catch(err){
          showError('MediaRecorder nicht verfÃ¼gbar.');
          console.error(err);
          return;
        }
      }
      recordedChunks = [];
      mediaRecorder.ondataavailable = (ev) => {
        if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data);
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'video/webm' });
        const a = document.createElement('a');
        a.download = 'area-ar-video-' + Date.now().toString(36) + '.webm';
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        flashCaptureStatus('Video gespeichert');
      };
      mediaRecorder.start();
      recording = true;
      btnVideo.classList.add('primary');
      btnVideo.textContent = 'âº Aufnahme lÃ¤uft';
      flashCaptureStatus('Videoaufnahme gestartet');
    }

    function stopVideoRecording(showMsg=true){
      if (!recording) return;
      try { mediaRecorder.stop(); } catch(_){}
      recording = false;
      btnVideo.classList.remove('primary');
      btnVideo.textContent = 'ðŸŽ¬ Video';
      if (showMsg) flashCaptureStatus('Videoaufnahme beendet');
    }

    btnVideo.addEventListener('click', () => {
      if (!recording) startVideoRecording();
      else stopVideoRecording(true);
    });

    /***********************
     * iOS Hinweis (Quick Look) *
     ***********************/
    const ua = navigator.userAgent || '';
    const isIOS = /iPhone|iPad|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    if (isIOS && !mv.getAttribute('ios-src')){
      // Hinweis anzeigen: Ohne USDZ kein Quick Look
      console.info('[viewer] iOS ohne USDZ â€“ AR evtl. nicht mÃ¶glich.');
    }
  })();
  </script>
</body>
</html>
