<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ARea Viewer â€“ Surface AR</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{color-scheme:dark light}
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0; height:100%;
      background:#000 !important;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      overscroll-behavior:none; touch-action:manipulation;
    }

    /* Poster */
    #poster{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:#05070c; z-index:9999; color:#fff; text-align:center; padding:24px;
    }
    #poster-inner{
      max-width:420px; width:100%; padding:24px 20px; border-radius:24px;
      background:radial-gradient(circle at top,#243b74,#05070c);
      box-shadow:0 18px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.15);
    }
    #posterImage{ width:100%; max-height:220px; object-fit:cover; border-radius:16px; display:none; margin-bottom:16px; background:#111; }
    #poster h1{ font-size:22px; margin:0 0 8px; }
    #poster p{ margin:0 0 16px; font-size:14px; opacity:0.9; }
    #startAr{
      appearance:none; border:none; border-radius:999px; padding:10px 22px; font-size:15px; font-weight:500;
      background:linear-gradient(135deg,#5ddcff,#3c67e3); color:#fff; cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,0.5);
    }
    #startAr[disabled]{ opacity:.55; cursor:wait; }

    /* model-viewer Host */
    model-viewer{
      position:fixed; inset:0; width:100vw; height:100svh; display:block;
      background:#000 !important; z-index:1;
    }

    /* Fehler */
    #err{
      position:fixed; left:12px; top:12px; z-index:10000; background:#b00020; color:#fff;
      padding:8px 10px; border-radius:8px; display:none; font:12px/1.35 monospace;
      max-width:min(92vw,680px); white-space:pre-wrap; box-shadow:0 4px 16px rgba(0,0,0,.5);
    }

    /* AR UI */
    #ar-ui{
      position:fixed; inset:0; z-index:9000; display:none; pointer-events:none; font-family:inherit;
    }
    #ar-ui .toolbar{
      position:absolute; top:12px; right:12px; display:flex; flex-direction:column; gap:8px; pointer-events:auto;
    }
    .ar-btn{
      appearance:none; border:none; border-radius:10px; padding:8px 12px; font-size:13px; font-weight:500;
      background:#1d2736; color:#fff; cursor:pointer; display:flex; align-items:center; gap:6px;
      box-shadow:0 4px 12px rgba(0,0,0,.5); backdrop-filter:blur(6px);
    }
    .ar-btn.primary{ background:linear-gradient(135deg,#5ddcff,#3c67e3); }
    .ar-btn.danger{ background:#b00020; }
    .ar-btn:active{ transform:translateY(1px); }

    #captureStatus{
      position:absolute; bottom:14px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.65); color:#fff; font:12px/1.3 monospace; padding:6px 10px;
      border-radius:8px; display:none; pointer-events:none; box-shadow:0 4px 14px rgba(0,0,0,.6);
    }

    /* Ring-Hotspots */
    .link-hotspot{
      position:relative; background:none; border:none; padding:0;
      width:64px; height:64px; cursor:pointer; display:inline-flex;
      align-items:center; justify-content:center; outline:none;
    }
    .link-hotspot .hotspot-ring{
      position:absolute; width:48px; height:48px; border:2px solid rgba(255,255,255,0.75);
      border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,0.55), 0 0 12px rgba(93,220,255,0.35);
      animation:hotspot-pulse 3s ease-in-out infinite; transition:border-color .25s, box-shadow .25s;
    }
    @keyframes hotspot-pulse{
      0%{ transform:scale(1); opacity:1; }
      50%{ transform:scale(1.12); opacity:.85; }
      100%{ transform:scale(1); opacity:1; }
    }
    .link-hotspot:focus .hotspot-ring,
    .link-hotspot:active .hotspot-ring{
      border-color:#5ddcff;
      box-shadow:0 0 0 2px rgba(0,0,0,.55), 0 0 16px #5ddcff, 0 0 4px #3c67e3 inset;
    }
    .link-hotspot:active .hotspot-ring{ animation:hotspot-tap .4s ease; }
    @keyframes hotspot-tap{ 0%{transform:scale(1);}40%{transform:scale(.85);}100%{transform:scale(1);} }
    .link-hotspot[data-style="invisible"] .hotspot-ring{ display:none; }
    .link-hotspot[data-style="icon"] .hotspot-ring{ display:none; }
    .link-hotspot[data-style="icon"] .hotspot-icon{
      font-size:26px; line-height:1; filter:drop-shadow(0 2px 4px rgba(0,0,0,.6));
    }
    .link-hotspot[data-style="invisible"]{ opacity:0; }

    @media (max-width:480px){
      #poster-inner{ padding:20px 16px; }
      #poster h1{ font-size:20px; }
      #startAr{ font-size:14px; padding:9px 18px; }
      .ar-btn{ font-size:12px; padding:7px 10px; }
      .link-hotspot{ width:56px; height:56px; }
      .link-hotspot .hotspot-ring{ width:42px; height:42px; }
    }
  </style>
</head>
<body>
  <div id="err"></div>

  <div id="poster">
    <div id="poster-inner">
      <img id="posterImage" alt="">
      <h1 id="posterTitle">ARea AR-Erlebnis</h1>
      <p id="posterDesc">Tippe auf â€žAR startenâ€œ, richte dein GerÃ¤t auf eine ebene FlÃ¤che und platziere dann das 3D-Modell.</p>
      <button id="startAr">AR starten</button>
    </div>
  </div>

  <div id="ar-ui">
    <div class="toolbar">
      <button id="btn-capture" class="ar-btn primary" title="Screenshot">ðŸ“· Screenshot</button>
      <button id="btn-video" class="ar-btn" title="Videoaufnahme">ðŸŽ¬ Video</button>
      <button id="btn-close-ar" class="ar-btn danger" title="AR beenden">âœ• Beenden</button>
    </div>
    <div id="captureStatus"></div>
  </div>

  <model-viewer id="mv"
    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
    exposure="1"
    shadow-intensity="1"
    interaction-prompt="none"
    camera-orbit="0deg 70deg auto"
    camera-target="auto"
    field-of-view="30deg"
    poster="">
  </model-viewer>

  <script type="module">
  (() => {
    const qs = new URLSearchParams(location.search);
    const DEV = qs.has('dev');
    const prefer = qs.get('prefer');

    const mv = document.getElementById('mv');
    const errBox = document.getElementById('err');

    const poster = document.getElementById('poster');
    const posterTitle = document.getElementById('posterTitle');
    const posterDesc  = document.getElementById('posterDesc');
    const posterImage = document.getElementById('posterImage');
    const startBtn    = document.getElementById('startAr');

    const arUi        = document.getElementById('ar-ui');
    const btnCapture  = document.getElementById('btn-capture');
    const btnVideo    = document.getElementById('btn-video');
    const btnCloseAr  = document.getElementById('btn-close-ar');
    const captureStatus = document.getElementById('captureStatus');

    if (prefer === 'native'){
      mv.setAttribute('ar-modes','scene-viewer webxr quick-look');
    } else {
      mv.setAttribute('ar-modes','webxr scene-viewer quick-look');
    }

    function showError(msg){
      errBox.textContent = msg;
      errBox.style.display = 'block';
      console.error('[viewer]', msg);
    }
    function hideError(){ errBox.style.display='none'; }
    function bust(u){
      if (!DEV || !u) return u;
      const sep = u.includes('?')?'&':'?';
      return u + sep + 'v=' + Date.now();
    }

    const defaultBase = 'https://area-publish.area-webar.workers.dev';
    const rawBase = (qs.get('base') || defaultBase);
    let workerBase = rawBase.split('"')[0].split(',')[0].trim()
      .replace(/\/scenes\/[^\/?#]+\/?$/,'')
      .replace(/\/+$/,'');
    if (!/^https?:\/\//i.test(workerBase)) workerBase = defaultBase;

    const sceneId      = (qs.get('scene') || qs.get('src') || '').trim();
    const overrideGlb  = (qs.get('glb')  || '').trim();
    const overrideUsdz = (qs.get('usdz') || '').trim();
    const isHttp = (u)=> /^https?:\/\//i.test(u);
    const isDataOrBlob = (u)=> u.startsWith('data:') || u.startsWith('blob:');

    let SCENE_GLB=''; let SCENE_JSON='';

    if (overrideGlb) SCENE_GLB = overrideGlb;
    if (sceneId){
      if (isHttp(sceneId)){
        if (sceneId.toLowerCase().match(/\.(glb|gltf)$/)){
          if (!SCENE_GLB) SCENE_GLB = sceneId;
        } else {
          SCENE_JSON = sceneId;
        }
      } else {
        const id = sceneId.replace(/\/+$/,'');
        if (!SCENE_GLB) SCENE_GLB = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.glb`;
        SCENE_JSON = `${workerBase}/scenes/${encodeURIComponent(id)}/scene.json`;
      }
    }

    const cfg = {
      glbUrl: SCENE_GLB || "https://modelviewer.dev/shared-assets/models/Astronaut.glb",
      usdzUrl: null,
      meta:{ title:null, description:null },
      welcome:{ title:null, desc:null, posterFile:null },
      audio:null,
      clickableNodes:[]
    };

    let audioEl = null;
    let recording=false, mediaRecorder=null, recordedChunks=[];

    function flashStatus(msg){
      captureStatus.textContent = msg;
      captureStatus.style.display='block';
      clearTimeout(captureStatus._t);
      captureStatus._t = setTimeout(()=> captureStatus.style.display='none',1800);
    }

    async function headOk(url){
      try {
        const r = await fetch(bust(url), { method:'HEAD', cache:'no-cache' });
        return r.ok;
      } catch { return false; }
    }

    function resolveRel(u){
      if (!u) return '';
      if (/^https?:\/\//i.test(u) || u.startsWith('data:')) return u;
      if (!sceneId) return u;
      return `${workerBase}/scenes/${encodeURIComponent(sceneId)}/${u}`;
    }

    async function loadScene(){
      try {
        if (SCENE_JSON && !isDataOrBlob(SCENE_JSON)){
          const r = await fetch(bust(SCENE_JSON), { cache:'no-cache' });
          if (!r.ok) throw new Error('scene.json: ' + r.status + ' ' + r.statusText);
          const j = await r.json();
          console.log('[viewer] scene.json:', j);

          if (j.meta){
            cfg.meta.title = j.meta.title || null;
            cfg.meta.description = j.meta.description || null;
          }
          if (j.audio && j.audio.url){
            cfg.audio = {
              url: resolveRel(j.audio.url),
              loop: !!j.audio.loop,
              delaySeconds: j.audio.delaySeconds || 0,
              volume: Math.min(1, Math.max(0, j.audio.volume ?? 0.8))
            };
          }
          if (j.clickableNodes && Array.isArray(j.clickableNodes)){
            cfg.clickableNodes = j.clickableNodes.map(n => ({
              url: n.url,
              position: Array.isArray(n.position)? n.position : [0,0,0],
              label: n.label || 'Link',
              style: n.style || 'ring',
              icon: n.icon || '',
              pulse: n.pulse !== false
            }));
          }
          if (j.model && j.model.url && !overrideGlb){
            cfg.glbUrl = resolveRel(j.model.url);
            SCENE_GLB = cfg.glbUrl;
          }
          if (j.model && j.model.usdzUrl && !overrideUsdz){
            cfg.usdzUrl = resolveRel(j.model.usdzUrl);
          }
          if (j.ui && j.ui.welcome){
            cfg.welcome.title     = j.ui.welcome.title || null;
            cfg.welcome.desc      = j.ui.welcome.desc || null;
            cfg.welcome.posterFile= j.ui.welcome.poster || null;
          }
        }

        const finalTitle = cfg.meta.title || cfg.welcome.title || "ARea AR-Erlebnis";
        const finalDesc  = cfg.meta.description || cfg.welcome.desc ||
          "Tippe auf â€žAR startenâ€œ, richte dein GerÃ¤t auf eine ebene FlÃ¤che und platziere dann das 3D-Modell.";
        posterTitle.textContent = finalTitle;
        posterDesc.textContent  = finalDesc;

        if (cfg.welcome.posterFile && sceneId){
          posterImage.src = bust(resolveRel(cfg.welcome.posterFile));
          posterImage.style.display='block';
        } else {
          posterImage.style.display='none';
        }

        const finalGlb = SCENE_GLB || cfg.glbUrl;
        if (finalGlb && !(await headOk(finalGlb))){
          showError('GLB nicht gefunden: ' + finalGlb);
        }
        mv.src = bust(finalGlb);

        if (cfg.usdzUrl) mv.setAttribute('ios-src', cfg.usdzUrl);
        else mv.removeAttribute('ios-src');

        if (cfg.audio){
          audioEl = new Audio();
          audioEl.src = bust(cfg.audio.url);
          audioEl.loop = cfg.audio.loop;
          audioEl.volume = cfg.audio.volume;
          audioEl.preload = 'auto';
          audioEl.crossOrigin = 'anonymous';
        }

        createLinkHotspots(cfg.clickableNodes);

      } catch(e){
        showError('Szene konnte nicht geladen werden: ' + e.message);
        console.error(e);
      }
    }

    function createLinkHotspots(nodes){
      if (!nodes || !nodes.length) return;
      nodes.forEach((node,i)=>{
        if (!node.url || !Array.isArray(node.position)) return;
        const btn = document.createElement('button');
        btn.slot = 'hotspot-'+i;
        btn.className = 'link-hotspot';
        btn.dataset.position = node.position.join(' ');
        btn.dataset.normal = '0 1 0';
        btn.dataset.style = node.style || 'ring';
        btn.setAttribute('type','button');
        btn.setAttribute('aria-label', node.label || 'Link');

        if (btn.dataset.style === 'icon' && node.icon){
          const iconSpan = document.createElement('span');
          iconSpan.className='hotspot-icon';
          iconSpan.textContent=node.icon;
          btn.appendChild(iconSpan);
        } else if (btn.dataset.style !== 'invisible') {
          const ring = document.createElement('span');
          ring.className='hotspot-ring';
          if (node.pulse === false) ring.style.animation='none';
          btn.appendChild(ring);
        }

        btn.addEventListener('click', ev => {
          ev.stopPropagation();
          window.open(node.url,'_blank','noopener');
        });

        mv.appendChild(btn);
      });
    }

    mv.addEventListener('load', () => {
      const names = mv.availableAnimations || [];
      if (names && names.length){
        mv.animationName = names[0];
        mv.play().catch(e=>console.warn('play failed', e));
      }
    });

    mv.addEventListener('ar-status', e => {
      if (e.detail.status === 'session-started'){
        arUi.style.display='block';
      } else if (e.detail.status === 'not-presenting'){
        arUi.style.display='none';
        poster.style.display='flex';
        stopVideoRecording(false);
        if (audioEl){ try{ audioEl.pause(); audioEl.currentTime=0; }catch(_){} }
      }
    });

    startBtn.addEventListener('click', async ev => {
      ev.preventDefault(); ev.stopPropagation(); hideError();
      if (!mv.hasAttribute('ar')){
        showError('AR nicht aktiviert (fehlendes ar-Attribut).');
        return;
      }
      if (typeof mv.canActivateAR === 'function' && !mv.canActivateAR()){
        showError('AR nicht unterstÃ¼tzt oder fehlende Voraussetzungen.');
        return;
      }
      startBtn.disabled = true;
      try {
        if (typeof mv.activateAR === 'function') await mv.activateAR();
        else if (typeof mv.enterAR === 'function') await mv.enterAR();
        else throw new Error('AR-Funktion nicht verfÃ¼gbar.');

        poster.style.display='none';
        if (audioEl){
          const delayMs = Math.max(0, (cfg.audio?.delaySeconds || 0) * 1000);
          setTimeout(()=> audioEl.play().catch(e=>console.warn('Audio play fail:', e)), delayMs);
        }
      } catch(e){
        showError('AR konnte nicht gestartet werden: '+ e.message);
        poster.style.display='flex';
      } finally {
        startBtn.disabled = false;
      }
    });

    btnCloseAr.addEventListener('click', () => {
      try { if (mv.isArActive && typeof mv.stopAr === 'function') mv.stopAr(); } catch(_){}
      arUi.style.display='none';
      poster.style.display='flex';
      stopVideoRecording(false);
      if (audioEl){ try{ audioEl.pause(); audioEl.currentTime=0; }catch(_){} }
    });

    btnCapture.addEventListener('click', () => {
      const canvas = mv.shadowRoot?.querySelector('canvas') || document.querySelector('canvas');
      if (!canvas){ showError('Kein Canvas fÃ¼r Screenshot gefunden.'); return; }
      canvas.toBlob(blob => {
        if (!blob) return;
        const a = document.createElement('a');
        a.download = 'area-ar-' + Date.now().toString(36) + '.png';
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        flashStatus('Screenshot gespeichert');
      }, 'image/png');
    });

    function startVideoRecording(){
      if (recording) return;
      const canvas = mv.shadowRoot?.querySelector('canvas') || document.querySelector('canvas');
      if (!canvas || !canvas.captureStream){ showError('Videoaufnahme nicht unterstÃ¼tzt.'); return; }
      const stream = canvas.captureStream(30);
      try {
        mediaRecorder = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp9' });
      } catch(e){
        try { mediaRecorder = new MediaRecorder(stream); }
        catch(err){ showError('MediaRecorder nicht verfÃ¼gbar.'); return; }
      }
      recordedChunks = [];
      mediaRecorder.ondataavailable = ev => { if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'video/webm' });
        const a = document.createElement('a');
        a.download = 'area-ar-video-' + Date.now().toString(36) + '.webm';
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        flashStatus('Video gespeichert');
      };
      mediaRecorder.start();
      recording = true;
      btnVideo.classList.add('primary');
      btnVideo.textContent='âº Aufnahme lÃ¤uft';
      flashStatus('Videoaufnahme gestartet');
    }

    function stopVideoRecording(showMsg=true){
      if (!recording) return;
      try { mediaRecorder.stop(); } catch(_){}
      recording=false;
      btnVideo.classList.remove('primary');
      btnVideo.textContent='ðŸŽ¬ Video';
      if (showMsg) flashStatus('Videoaufnahme beendet');
    }

    btnVideo.addEventListener('click', () => {
      if (!recording) startVideoRecording();
      else stopVideoRecording(true);
    });

    loadScene();
  })();
  </script>
</body>
</html>
